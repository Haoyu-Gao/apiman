name: trigger release from file
on:
  push:
    paths:
      - ".github/workflows/RELEASE_VERSION"
  
  workflow_dispatch:

jobs:
  read-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read-version.outputs.version }}
    steps:
      - name: Checkout Apiman Docker repo
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: adopt
          java-version: 11
          cache: maven

      - name: "Read release version"
        id: read-version
        run: echo "APIMAN_VERSION=$(head -n1 .github/workflows/RELEASE_VERSION) >> $GITHUB_ENV"

      - name: Update Maven versions, including parent (if version changed)
        run: |
          mvn clean install
          mvn -ntp -N versions:update-parent -DparentVersion="[${{ env.APIMAN_VERSION }}]" -DgenerateBackupPoms=false
          mvn -ntp versions:set -DnewVersion="${{ env.APIMAN_VERSION }}" -DgenerateBackupPoms=false -DprocessAllModules=true
          mvn clean install
          
      - uses: EndBug/add-and-commit@v9
        with:
          message: "Bump Apiman version to ${{ env.APIMAN_VERSION }}"

      - name: Tag release
        run: |
          git tag -f -a -m "Apiman Docker tag release ${{ env.APIMAN_VERSION }}" ${{ env.APIMAN_VERSION }}
          git push origin HEAD:master ${{ env.APIMAN_VERSION }} --tags

      - name: Create GitHub release ${{ env.APIMAN_VERSION }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.APIMAN_VERSION }}
          name: ${{ env.APIMAN_VERSION }}
          files: |
            docker-compose/target/apiman-docker-compose-${{ env.APIMAN_VERSION }}.zip
          body: |
            Apiman Docker release for Apiman version ${{ env.APIMAN_VERSION }}.
            
            To access the images associated with this build, please look on Apiman's DockerHub or our GHCR registry (GitHub Packages).   

  build:
    needs: read-version
    uses: apiman/apiman-docker/.github/workflows/docker-test-release.yml@master
    secrets: inherit
    with:
      apiman-version: ${{ needs.read-version.outputs.version }}
      push-to-repos: false
      snapshot: false

  deploy:
    needs: [read-version, build]
    uses: apiman/apiman-docker/.github/workflows/docker-test-release.yml@master
    secrets: inherit
    with:
      apiman-version: ${{ needs.read-version.outputs.version }}
      push-to-repos: true
      snapshot: false
